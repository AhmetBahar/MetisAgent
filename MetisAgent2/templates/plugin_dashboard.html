<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MetisAgent2 - Plugin Management</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .plugin-card {
            border-left: 4px solid #dee2e6;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }
        .plugin-card.enabled { border-left-color: #198754; }
        .plugin-card.disabled { border-left-color: #6c757d; }
        .plugin-card.loaded { border-left-color: #0d6efd; }
        .plugin-card.error { border-left-color: #dc3545; }
        
        .tool-section {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 20px;
            background: #f8f9fa;
        }
        
        .status-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        
        .action-btn {
            margin: 2px;
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }
        
        .plugin-actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .internal-tools {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
        }
        
        .external-tools {
            background: linear-gradient(135deg, #f1f8e9 0%, #fff3e0 100%);
        }
        
        .install-section {
            background: linear-gradient(135deg, #fff8e1 0%, #f3e5f5 100%);
            border: 2px dashed #ffc107;
        }
        
        .log-container {
            background: #212529;
            color: #fff;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3 mb-0">
                        <i class="fas fa-plug text-primary"></i>
                        Plugin Management Dashboard
                    </h1>
                    <div>
                        <button class="btn btn-outline-primary btn-sm" onclick="refreshPlugins()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="btn btn-success btn-sm" onclick="showInstallModal()">
                            <i class="fas fa-plus"></i> Install Plugin
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-primary">Internal Tools</h5>
                        <h2 class="mb-0" id="internal-count">-</h2>
                        <small class="text-muted">Core System</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-success">External Tools</h5>
                        <h2 class="mb-0" id="external-count">-</h2>
                        <small class="text-muted">Plugins</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-info">Loaded</h5>
                        <h2 class="mb-0" id="loaded-count">-</h2>
                        <small class="text-muted">Active</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-warning">Installed Plugins</h5>
                        <h2 class="mb-0" id="installed-count">-</h2>
                        <small class="text-muted">Dynamic Tools</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Internal Tools -->
            <div class="col-lg-6">
                <div class="tool-section internal-tools">
                    <div class="card-header bg-transparent">
                        <h5 class="mb-0">
                            <i class="fas fa-cog text-primary"></i>
                            Internal Tools (Core System)
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="internal-tools-list">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin"></i> Loading...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- External Tools -->
            <div class="col-lg-6">
                <div class="tool-section external-tools">
                    <div class="card-header bg-transparent">
                        <h5 class="mb-0">
                            <i class="fas fa-puzzle-piece text-success"></i>
                            External Tools (Plugins)
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="external-tools-list">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin"></i> Loading...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Installed Plugins -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="tool-section">
                    <div class="card-header bg-transparent">
                        <h5 class="mb-0">
                            <i class="fas fa-download text-info"></i>
                            Installed Dynamic Plugins
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="installed-plugins-list">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin"></i> Loading...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Log -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-list text-secondary"></i>
                            Activity Log
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="log-container p-3" id="activity-log">
                            <div class="text-muted">System ready. Waiting for plugin operations...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Install Plugin Modal -->
    <div class="modal fade" id="installModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Install New Plugin</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="install-form">
                        <div class="mb-3">
                            <label class="form-label">Plugin Source</label>
                            <input type="text" class="form-control" id="plugin-source" 
                                   placeholder="Local path, GitHub repo, or URL" required>
                            <div class="form-text">
                                Examples: /path/to/plugin, owner/repo, https://github.com/owner/repo/archive/main.zip
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Plugin Name (Optional)</label>
                            <input type="text" class="form-control" id="plugin-name" 
                                   placeholder="Auto-detected if empty">
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="force-install">
                            <label class="form-check-label" for="force-install">
                                Force install (overwrite existing)
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="installPlugin()">
                        <i class="fas fa-download"></i> Install
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script>
        let installModal;
        
        document.addEventListener('DOMContentLoaded', function() {
            installModal = new bootstrap.Modal(document.getElementById('installModal'));
            loadPluginData();
        });

        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('activity-log');
            const timestamp = new Date().toLocaleTimeString();
            const iconClass = {
                'info': 'fas fa-info-circle text-info',
                'success': 'fas fa-check-circle text-success', 
                'error': 'fas fa-exclamation-circle text-danger',
                'warning': 'fas fa-exclamation-triangle text-warning'
            }[type] || 'fas fa-info-circle text-info';
            
            const logEntry = document.createElement('div');
            logEntry.innerHTML = \`<span class="text-muted">[\${timestamp}]</span> <i class="\${iconClass}"></i> \${message}\`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        async function loadPluginData() {
            try {
                addLog('Loading plugin data...');
                
                // Load internal tools
                const internalResponse = await fetch('/api/tools/internal');
                const internalData = await internalResponse.json();
                
                // Load external tools  
                const externalResponse = await fetch('/api/tools/external');
                const externalData = await externalResponse.json();
                
                // Load installed plugins
                const installedResponse = await fetch('/api/plugins/list_installed_tools', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tool: 'tool_manager', action: 'list_installed_tools' })
                });
                const installedData = await installedResponse.json();
                
                updateStats(internalData, externalData, installedData);
                renderInternalTools(internalData);
                renderExternalTools(externalData);
                renderInstalledPlugins(installedData);
                
                addLog('Plugin data loaded successfully', 'success');
            } catch (error) {
                addLog(\`Error loading plugin data: \${error.message}\`, 'error');
            }
        }

        function updateStats(internal, external, installed) {
            document.getElementById('internal-count').textContent = internal?.tools?.length || 0;
            document.getElementById('external-count').textContent = external?.tools?.length || 0;
            document.getElementById('installed-count').textContent = installed?.data?.count || 0;
            
            // Calculate loaded count
            let loadedCount = 0;
            if (installed?.data?.installed_tools) {
                loadedCount = installed.data.installed_tools.filter(tool => tool.loaded).length;
            }
            document.getElementById('loaded-count').textContent = loadedCount;
        }

        function renderInternalTools(data) {
            const container = document.getElementById('internal-tools-list');
            if (!data?.tools) {
                container.innerHTML = '<div class="alert alert-warning">No internal tools found</div>';
                return;
            }
            
            container.innerHTML = data.tools.map(tool => \`
                <div class="plugin-card card border-0 shadow-sm enabled">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">\${tool.name}</h6>
                                <p class="text-muted small mb-2">\${tool.description || 'Core system tool'}</p>
                                <div>
                                    <span class="badge bg-primary status-badge">Internal</span>
                                    <span class="badge bg-success status-badge">Always Active</span>
                                </div>
                            </div>
                            <div class="plugin-actions">
                                <button class="btn btn-outline-info action-btn" onclick="showToolInfo('\${tool.name}')">
                                    <i class="fas fa-info"></i> Info
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            \`).join('');
        }

        function renderExternalTools(data) {
            const container = document.getElementById('external-tools-list');
            if (!data?.tools) {
                container.innerHTML = '<div class="alert alert-warning">No external tools found</div>';
                return;
            }
            
            container.innerHTML = data.tools.map(tool => \`
                <div class="plugin-card card border-0 shadow-sm enabled">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">\${tool.name}</h6>
                                <p class="text-muted small mb-2">\${tool.description || 'External plugin tool'}</p>
                                <div>
                                    <span class="badge bg-success status-badge">External</span>
                                    <span class="badge bg-info status-badge">Plugin</span>
                                </div>
                            </div>
                            <div class="plugin-actions">
                                <button class="btn btn-outline-info action-btn" onclick="showToolInfo('\${tool.name}')">
                                    <i class="fas fa-info"></i> Info
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            \`).join('');
        }

        function renderInstalledPlugins(data) {
            const container = document.getElementById('installed-plugins-list');
            if (!data?.data?.installed_tools || data.data.installed_tools.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No dynamic plugins installed yet. Use the "Install Plugin" button to add new tools.</div>';
                return;
            }
            
            container.innerHTML = data.data.installed_tools.map(plugin => \`
                <div class="plugin-card card border-0 shadow-sm \${plugin.enabled ? 'enabled' : 'disabled'}">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">\${plugin.name}</h6>
                                <p class="text-muted small mb-2">\${plugin.description || 'Dynamic plugin'}</p>
                                <div class="mb-2">
                                    <span class="badge bg-warning status-badge">Dynamic</span>
                                    <span class="badge \${plugin.enabled ? 'bg-success' : 'bg-secondary'} status-badge">
                                        \${plugin.enabled ? 'Enabled' : 'Disabled'}
                                    </span>
                                    <span class="badge \${plugin.loaded ? 'bg-info' : 'bg-light text-dark'} status-badge">
                                        \${plugin.loaded ? 'Loaded' : 'Not Loaded'}
                                    </span>
                                </div>
                                <small class="text-muted">
                                    v\${plugin.version} by \${plugin.author}
                                    \${plugin.installed_at ? \`â€¢ Installed: \${new Date(plugin.installed_at).toLocaleDateString()}\` : ''}
                                </small>
                            </div>
                            <div class="plugin-actions">
                                <button class="btn btn-outline-info action-btn" onclick="showToolInfo('\${plugin.name}')">
                                    <i class="fas fa-info"></i> Info
                                </button>
                                \${plugin.enabled ? 
                                    \`<button class="btn btn-outline-secondary action-btn" onclick="disablePlugin('\${plugin.name}')">
                                        <i class="fas fa-pause"></i> Disable
                                    </button>\` :
                                    \`<button class="btn btn-outline-success action-btn" onclick="enablePlugin('\${plugin.name}')">
                                        <i class="fas fa-play"></i> Enable
                                    </button>\`
                                }
                                <button class="btn btn-outline-warning action-btn" onclick="reloadPlugin('\${plugin.name}')">
                                    <i class="fas fa-sync-alt"></i> Reload
                                </button>
                                <button class="btn btn-outline-danger action-btn" onclick="removePlugin('\${plugin.name}')">
                                    <i class="fas fa-trash"></i> Remove
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            \`).join('');
        }

        function showInstallModal() {
            document.getElementById('install-form').reset();
            installModal.show();
        }

        async function installPlugin() {
            const source = document.getElementById('plugin-source').value.trim();
            const name = document.getElementById('plugin-name').value.trim();
            const force = document.getElementById('force-install').checked;
            
            if (!source) {
                alert('Please enter a plugin source');
                return;
            }
            
            try {
                addLog(\`Installing plugin from: \${source}\`);
                installModal.hide();
                
                const response = await fetch('/api/plugins/install_tool', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tool: 'tool_manager',
                        action: 'install_tool',
                        source: source,
                        name: name || undefined,
                        force: force
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addLog(\`Plugin installed successfully: \${result.data?.tool_name || 'Unknown'}\`, 'success');
                    await loadPluginData(); // Refresh data
                } else {
                    addLog(\`Plugin installation failed: \${result.error}\`, 'error');
                }
            } catch (error) {
                addLog(\`Installation error: \${error.message}\`, 'error');
            }
        }

        async function enablePlugin(pluginName) {
            try {
                addLog(\`Enabling plugin: \${pluginName}\`);
                
                const response = await fetch('/api/plugins/enable_tool', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tool: 'tool_manager',
                        action: 'enable_tool',
                        target_tool: pluginName
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addLog(\`Plugin enabled: \${pluginName}\`, 'success');
                    await loadPluginData();
                } else {
                    addLog(\`Failed to enable plugin: \${result.error}\`, 'error');
                }
            } catch (error) {
                addLog(\`Enable error: \${error.message}\`, 'error');
            }
        }

        async function disablePlugin(pluginName) {
            try {
                addLog(\`Disabling plugin: \${pluginName}\`);
                
                const response = await fetch('/api/plugins/disable_tool', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tool: 'tool_manager',
                        action: 'disable_tool',
                        target_tool: pluginName
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addLog(\`Plugin disabled: \${pluginName}\`, 'success');
                    await loadPluginData();
                } else {
                    addLog(\`Failed to disable plugin: \${result.error}\`, 'error');
                }
            } catch (error) {
                addLog(\`Disable error: \${error.message}\`, 'error');
            }
        }

        async function reloadPlugin(pluginName) {
            try {
                addLog(\`Reloading plugin: \${pluginName}\`);
                
                const response = await fetch('/api/plugins/reload_tool', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tool: 'tool_manager',
                        action: 'reload_tool',
                        target_tool: pluginName
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addLog(\`Plugin reloaded: \${pluginName}\`, 'success');
                    await loadPluginData();
                } else {
                    addLog(\`Failed to reload plugin: \${result.error}\`, 'error');
                }
            } catch (error) {
                addLog(\`Reload error: \${error.message}\`, 'error');
            }
        }

        async function removePlugin(pluginName) {
            if (!confirm(\`Are you sure you want to remove plugin '\${pluginName}'? This action cannot be undone.\`)) {
                return;
            }
            
            try {
                addLog(\`Removing plugin: \${pluginName}\`);
                
                const response = await fetch('/api/plugins/remove_tool', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tool: 'tool_manager',
                        action: 'remove_tool',
                        target_tool: pluginName
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addLog(\`Plugin removed: \${pluginName}\`, 'success');
                    await loadPluginData();
                } else {
                    addLog(\`Failed to remove plugin: \${result.error}\`, 'error');
                }
            } catch (error) {
                addLog(\`Remove error: \${error.message}\`, 'error');
            }
        }

        async function showToolInfo(toolName) {
            try {
                const response = await fetch('/api/plugins/get_tool_info', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tool: 'tool_manager',
                        action: 'get_tool_info',
                        target_tool: toolName
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const info = result.data;
                    alert(\`Tool Information: \${toolName}\\n\\n\` +
                        \`Description: \${info.description || 'N/A'}\\n\` +
                        \`Version: \${info.version || 'N/A'}\\n\` +
                        \`Type: \${info.is_dynamic ? 'Dynamic Plugin' : 'Built-in Tool'}\\n\` +
                        \`Status: \${info.enabled ? 'Enabled' : 'Disabled'}\\n\` +
                        \`In Registry: \${info.in_registry ? 'Yes' : 'No'}\\n\` +
                        \`Actions: \${Object.keys(info.actions || {}).join(', ') || 'None'}\`);
                } else {
                    alert(\`Failed to get tool info: \${result.error}\`);
                }
            } catch (error) {
                alert(\`Error getting tool info: \${error.message}\`);
            }
        }

        function refreshPlugins() {
            addLog('Refreshing plugin data...');
            loadPluginData();
        }
    </script>
</body>
</html>